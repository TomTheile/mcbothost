<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neues Passwort setzen - Herobrine AFK Bot</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header (Top) -->
        <div class="header">
            <h1>Herobrine AFK Bot</h1>
            <div class="quick-links">
                <a href="index.html">Zur√ºck zur Anmeldung</a>
            </div>
        </div>

        <div class="main-content">
            <!-- Neues Passwort setzen -->
            <div class="auth-section green-border">
                <h2>Neues Passwort festlegen</h2>
                <p>Gib dein neues Passwort ein, um den Zur√ºcksetzungsprozess abzuschlie√üen.</p>
                
                <div id="loading-container" style="text-align: center; display: block;">
                    <div style="border: 4px solid rgba(30, 255, 0, 0.3); border-radius: 50%; border-top: 4px solid #1eff00; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;"></div>
                    <p>√úberpr√ºfe den Link...</p>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                </div>
                
                <div id="error-container" style="display: none;">
                    <div class="status-message error">
                        <p>Der Link ist ung√ºltig oder abgelaufen. Bitte fordere einen neuen Link zum Zur√ºcksetzen deines Passworts an.</p>
                    </div>
                    <a href="forgot-password.html" class="auth-btn" style="display: inline-block; text-align: center; margin-top: 20px; text-decoration: none;">Neuen Link anfordern</a>
                </div>
                
                <form id="reset-form" style="display: none;">
                    <div class="form-group">
                        <label>Neues Passwort</label>
                        <input type="password" id="new-password" placeholder="Gib dein neues Passwort ein" required>
                    </div>
                    <div class="form-group">
                        <label>Passwort best√§tigen</label>
                        <input type="password" id="confirm-password" placeholder="Best√§tige dein neues Passwort" required>
                    </div>
                    
                    <button type="submit" class="auth-btn" id="reset-password-btn">Passwort √§ndern</button>
                </form>
                
                <div id="success-container" style="display: none;">
                    <div class="status-message success">
                        <p>Dein Passwort wurde erfolgreich ge√§ndert! Du kannst dich jetzt mit deinem neuen Passwort anmelden.</p>
                    </div>
                    <a href="index.html" class="auth-btn" style="display: inline-block; text-align: center; margin-top: 20px; text-decoration: none;">Zur Anmeldung</a>
                </div>
            </div>

            <!-- Informationsbox -->
            <div class="quick-guide green-border">
                <h3>üîê Passwort-Tipps</h3>
                <div class="guide-box">
                    <div class="guide-step">üîë <strong>Stark</strong> ‚Äì Nutze mindestens 8 Zeichen</div>
                </div>
                <div class="guide-box">
                    <div class="guide-step">üî¢ <strong>Komplex</strong> ‚Äì Kombiniere Buchstaben, Zahlen und Sonderzeichen</div>
                </div>
                <div class="guide-box">
                    <div class="guide-step">‚ö†Ô∏è <strong>Einzigartig</strong> ‚Äì Verwende kein Passwort, das du bereits f√ºr andere Dienste nutzt</div>
                </div>
                <div class="guide-box">
                    <div class="guide-step">üß† <strong>Merkbar</strong> ‚Äì W√§hle ein Passwort, das du dir leicht merken kannst</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Der fortschrittliche Minecraft Bot-Service</p>
            <div class="footer-links">
                <a href="#">Nutzungsbedingungen</a>
                <a href="#">Datenschutz</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { updatePassword } from './database.js';
        
        // DOM-Elemente
        const loadingContainer = document.getElementById('loading-container');
        const errorContainer = document.getElementById('error-container');
        const resetForm = document.getElementById('reset-form');
        const successContainer = document.getElementById('success-container');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        
        // Funktion zum Parsen der URL-Parameter
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            
            for (const [key, value] of urlParams.entries()) {
                params[key] = value;
            }
            
            return params;
        }
        
        // Funktion zum Erstellen von Statusnachrichten
        function createStatusMessage(message, isError = false) {
            const statusDiv = document.createElement('div');
            statusDiv.classList.add('status-message');
            statusDiv.classList.add(isError ? 'error' : 'success');
            statusDiv.textContent = message;
            return statusDiv;
        }
        
        // Funktion zum Entfernen aller Statusnachrichten
        function clearStatusMessages(formElement) {
            const messages = formElement.querySelectorAll('.status-message');
            messages.forEach(msg => msg.remove());
        }
        
        // Link √ºberpr√ºfen und Formular anzeigen
        function checkResetLink() {
            const params = getUrlParams();
            const token = params.token;
            const email = params.email;
            
            // Simulierte √úberpr√ºfung (in einer echten App w√ºrde dies auf dem Server √ºberpr√ºft)
            if (!token || !email) {
                // Ung√ºltiger Link
                loadingContainer.style.display = 'none';
                errorContainer.style.display = 'block';
                return;
            }
            
            // Link simuliert validieren (mit kurzer Verz√∂gerung)
            setTimeout(() => {
                // Formular anzeigen
                loadingContainer.style.display = 'none';
                resetForm.style.display = 'block';
                
                // E-Mail-Adresse f√ºr sp√§teren Gebrauch speichern
                resetForm.dataset.email = email;
                resetForm.dataset.token = token;
            }, 1500);
        }
        
        // Event-Listener f√ºr das Passwort-Zur√ºcksetzungsformular
        resetForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            clearStatusMessages(resetForm);
            
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const email = resetForm.dataset.email;
            const token = resetForm.dataset.token;
            
            // Passw√∂rter √ºberpr√ºfen
            if (newPassword !== confirmPassword) {
                const errorMsg = createStatusMessage('Die Passw√∂rter stimmen nicht √ºberein!', true);
                resetForm.appendChild(errorMsg);
                return;
            }
            
            if (newPassword.length < 6) {
                const errorMsg = createStatusMessage('Das Passwort muss mindestens 6 Zeichen lang sein!', true);
                resetForm.appendChild(errorMsg);
                return;
            }
            
            try {
                // Button deaktivieren w√§hrend des Zur√ºcksetzens
                resetPasswordBtn.disabled = true;
                resetPasswordBtn.textContent = 'Wird ge√§ndert...';
                
                // Simuliere API-Aufruf (in einer echten App w√ºrde dies auf dem Server erfolgen)
                // Verz√∂gerung simulieren
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Erfolg simulieren und UI aktualisieren
                resetForm.style.display = 'none';
                successContainer.style.display = 'block';
                
                // In einer echten App w√ºrde hier der Benutzer im localStorage/sessionStorage aktualisiert
                
            } catch (error) {
                console.error('Fehler beim Zur√ºcksetzen des Passworts:', error);
                const errorMsg = createStatusMessage('Ein Fehler ist aufgetreten: ' + error.message, true);
                resetForm.appendChild(errorMsg);
                resetPasswordBtn.disabled = false;
                resetPasswordBtn.textContent = 'Passwort √§ndern';
            }
        });
        
        // Beim Laden der Seite den Link √ºberpr√ºfen
        document.addEventListener('DOMContentLoaded', checkResetLink);
    </script>
</body>
</html>
